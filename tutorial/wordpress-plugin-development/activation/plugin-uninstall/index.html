<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=description content="In this tutorial, we use WordPress Plugin Uninstall hook to clean up the entities created by the plugin with uninstall.php mechanism provided by WordPress."><meta name=author content="Maithilish"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYHTHXW09H"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYHTHXW09H")</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://google.com/article"},"articleSection":"tutorial","name":"Uninstall - WordPress Plugin Development - CodeTab","headline":"Uninstall - WordPress Plugin Development - CodeTab","url":"https://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-uninstall/","description":"In this tutorial, we use WordPress Plugin Uninstall hook to clean up the entities created by the plugin with uninstall.php mechanism provided by WordPress.","inLanguage":"en","image":"https://www.codetab.org/logo.jpg","author":"Maithilish","creator":"Maithilish","publisher":{"@type":"Organization","name":"Maithilish","url":"https://www.codetab.org/","logo":{"@type":"ImageObject","url":"https://www.codetab.org/logo.png","width":"200","height":"200"}},"copyrightHolder":"Maithilish","copyrightYear":"2019","datePublished":"2019-01-11T12:42:00+0530","dateModified":"2019-01-11T12:42:00+0530","wordCount":"484","keywords":["wordpress plugin uninstall","Blog"]}</script><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/vendor.min.b34f4a49e8fbf83dd7dd8f945eb35a939c19aa15051f677ac5a9c057ac6c8774.css integrity="sha256-s09KSej7+D3X3Y+UXrNak5wZqhUFH2d6xanAV6xsh3Q="><title>Uninstall - WordPress Plugin Development - CodeTab</title>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1281079745125126" crossorigin=anonymous></script></head><body id=top><header><nav id=navbar-main class="navbar fixed-top navbar-light navbar-expand-lg bg-white border-bottom shadow-sm"><div class=container-fluid><a class=navbar-brand href=/>Codetab</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbar aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbar><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/#tutorials><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/post><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#about><span>About</span></a></li></ul></div></div></nav></header><div class=container-fluid><div class=row>&nbsp;</div><div class=row><aside id=sidebar class=col-md-3><div class=row><nav id=navbar-side class="bg-light text-secondary"><h4 class="text-muted bg-white pl-2">WP Plugin Development</h4><nav class="navbar navbar-light bg-white navbar-expand-md"><button class="navbar-toggler ml-auto" type=button data-toggle=collapse data-target=#bookmenu aria-controls=bookmenu aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=bookmenu><div><div id="WordPress Plugin Development - CodeTab"><div><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/introduction/ class="toc-page text-wrap text-muted">Introduction</a></div><div><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/install-locally/ class="toc-page text-wrap text-muted">Install WP on Docker</a></div><div><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/simple-plugin/ class="toc-page text-wrap text-muted">Simple Plugin</a></div><div><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/shortcode/ class="toc-page text-wrap text-muted">Shortcode</a></div><div><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/plugin-structure/ class="toc-page text-wrap text-muted">Plugin Structure</a></div><div><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/plugin-main-file/ class="toc-page text-wrap text-muted">Main File</a></div><div><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/hooks-actions-filters/ class="toc-page text-wrap text-muted">Hooks, Actions, Filters</a></div></div><div class="dropdown show mt-2"><a class="no-collapse-on-click card-link toc-section text-dark" href=#tutorial-wordpress-plugin-development-admin-module-settings id=dropdownheader data-toggle=collapse aria-haspopup=true aria-expanded=false>Admin - Settings</a><div id=tutorial-wordpress-plugin-development-admin-module-settings class=collapse><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-settings/add-menu/ class="toc-page dropdown-item text-wrap text-muted">Add Menu
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-settings/settings-api/ class="toc-page dropdown-item text-wrap text-muted">Settings API
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-settings/options-page/ class="toc-page dropdown-item text-wrap text-muted">Options Page</a></div></div><div class="dropdown show mt-2"><a class="no-collapse-on-click card-link toc-section text-dark" href=#tutorial-wordpress-plugin-development-admin-module-custom-posts id=dropdownheader data-toggle=collapse aria-haspopup=true aria-expanded=false>Admin - Posts</a><div id=tutorial-wordpress-plugin-development-admin-module-custom-posts class=collapse><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-custom-posts/post-type/ class="toc-page dropdown-item text-wrap text-muted">Custom Post Type
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-custom-posts/meta-box/ class="toc-page dropdown-item text-wrap text-muted">Meta Box
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-custom-posts/save-post/ class="toc-page dropdown-item text-wrap text-muted">Save Post</a></div></div><div class="dropdown show mt-2"><a class="no-collapse-on-click card-link toc-section text-dark" href=#tutorial-wordpress-plugin-development-frontend id=dropdownheader data-toggle=collapse aria-haspopup=true aria-expanded=false>Frontend</a><div id=tutorial-wordpress-plugin-development-frontend class=collapse><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/frontend/enqueue-scripts/ class="toc-page dropdown-item text-wrap text-muted">Plugin Enqueue Scripts
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/frontend/pass-data-to-javascript/ class="toc-page dropdown-item text-wrap text-muted">Pass Data to JavaScript
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/frontend/debug-info/ class="toc-page dropdown-item text-wrap text-muted">Debug Info</a></div></div><div class="dropdown show mt-2"><a class="no-collapse-on-click card-link toc-section text-dark" href=#tutorial-wordpress-plugin-development-ajax id=dropdownheader data-toggle=collapse aria-haspopup=true aria-expanded=false>Ajax</a><div id=tutorial-wordpress-plugin-development-ajax class=collapse><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/ajax/wordpress-ajax/ class="toc-page dropdown-item text-wrap text-muted">Ajax
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/ajax/chart-page/ class="toc-page dropdown-item text-wrap text-muted">Chart Page
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/ajax/google-charts/ class="toc-page dropdown-item text-wrap text-muted">Google Charts</a></div></div><div class="dropdown show mt-2"><a class="no-collapse-on-click card-link toc-section text-dark" href=#tutorial-wordpress-plugin-development-internationalization id=dropdownheader data-toggle=collapse aria-haspopup=true aria-expanded=false>Internationalization</a><div id=tutorial-wordpress-plugin-development-internationalization class=collapse><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/internationalization/internationalize/ class="toc-page dropdown-item text-wrap text-muted">Internationalization
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/internationalization/localization/ class="toc-page dropdown-item text-wrap text-muted">Localization</a></div></div><div class="dropdown show mt-2"><a class="no-collapse-on-click card-link toc-section text-dark" href=#tutorial-wordpress-plugin-development-activation id=dropdownheader data-toggle=collapse aria-haspopup=true aria-expanded=false>Activation</a><div id=tutorial-wordpress-plugin-development-activation><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-activation/ class="toc-page dropdown-item text-wrap text-muted">Activation
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/activation/enable-multisite/ class="toc-page dropdown-item text-wrap text-muted">Multi site
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/activation/multisite-activation/ class="toc-page dropdown-item text-wrap text-muted">Multi site Activation
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-deactivation/ class="toc-page dropdown-item text-wrap text-muted">Deactivation
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-uninstall/ class="toc-page dropdown-item text-wrap text-danger">Uninstall</a></div></div><div class="dropdown show mt-2"><a class="no-collapse-on-click card-link toc-section text-dark" href=#tutorial-wordpress-plugin-development-unit-test id=dropdownheader data-toggle=collapse aria-haspopup=true aria-expanded=false>Testing</a><div id=tutorial-wordpress-plugin-development-unit-test class=collapse><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/plugin-unit-testing/ class="toc-page dropdown-item text-wrap text-muted">Unit Test
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/setup/ class="toc-page dropdown-item text-wrap text-muted">Test Setup
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/simple-unit-tests/ class="toc-page dropdown-item text-wrap text-muted">Simple Unit Tests
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/scripts-actions-filters/ class="toc-page dropdown-item text-wrap text-muted">Unit Test Scripts, Actions, Filters
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/advanced-unit-tests/ class="toc-page dropdown-item text-wrap text-muted">Advanced Unit Tests
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/internationalization-functions/ class="toc-page dropdown-item text-wrap text-muted">Test Internationalization Functions
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/ajax/ class="toc-page dropdown-item text-wrap text-muted">Ajax Unit Tests
</a><a href=https://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/multisite-plugin-unit-tests/ class="toc-page dropdown-item text-wrap text-muted">Multi site Plugin Unit Tests</a></div></div></div></div></nav></nav></div></aside><div id=contentbar class=col-md-8><div id=share class="row justify-content-end"><div title=twitter><a href="https://twitter.com/intent/tweet?url=https://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-uninstall/&amp;text=Uninstall%20-%20WordPress%20Plugin%20Development%20-%20CodeTab" target=_blank rel=noopener><i class="icon-twitter-squared text-secondary"></i></a></div><div title=facebook><a href="https://www.facebook.com/sharer.php?u=https://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-uninstall/&amp;t=Uninstall%20-%20WordPress%20Plugin%20Development%20-%20CodeTab" target=_blank rel=noopener><i class="icon-facebook-squared text-secondary"></i></a></div><div title=linkedin><a href="https://www.linkedin.com/shareArticle?url=https://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-uninstall/&amp;title=Uninstall%20-%20WordPress%20Plugin%20Development%20-%20CodeTab" target=_blank rel=noopener><i class="icon-linkedin-squared text-secondary"></i></a></div><div title=email><a href="mailto:?subject=Uninstall%20-%20WordPress%20Plugin%20Development%20-%20CodeTab&amp;body=https://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-uninstall/" target=_blank rel=noopener><i class="icon-mail-squared text-secondary"></i></a></div><div title=whatsapp><a href="https://web.whatsapp.com/send?text=Uninstall%20-%20WordPress%20Plugin%20Development%20-%20CodeTab%20https://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-uninstall/" target=_blank rel=noopener><i class="icon-whatsapp text-secondary"></i></a></div><div title=reddit><a href="https://reddit.com/submit?url=https://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-uninstall/&amp;title=Uninstall%20-%20WordPress%20Plugin%20Development%20-%20CodeTab" target=_blank rel=noopener><i class="icon-reddit-alien text-secondary"></i></a></div><i class="icon-blank ctab-transparent"></i></div><div class=row><main id=content class="col-md-11 post-basic"><h2 id=115wordpress-plugin-uninstall>11.5. WordPress Plugin Uninstall</h2><p>In the previous blogs, we customized activation and deactivation phases
for the plugin. In this tutorial, we use uninstall phase to clean up the
entities created by the plugin.</p><p>When a plugin is uninstalled, it is already in deactivated state and it
means that WordPress Action framework is no longer usable with in the
plugin code. WordPress do provide a uninstall hook
<a href=http://codex.wordpress.org/Function_Reference/register_uninstall_hook target=_blank>register_uninstall_hook()</a>,
but when when a plugin can not be written without running code within
the plugin there is another mechanism to handle uninstall. When
uninstall is in progress, WordPress looks for a file named named
uninstall.php in plugins&rsquo; top directory and if exists, it executes it as
part of uninstall phase. In Share on Social Plugin, we use unistall.php
instead of uninstall hook.</p><p>When plugin uninstall is initiated by the admin, WordPress sets a
constant <strong>WP_UNINSTALL_PLUGIN</strong> and share-on-social/uninstall.php
checks whether this constant is defined and if so, then proceeds to call
uninstall function <code>sos_uninstall_sos_plugin()</code>.</p><p><code>share-on-social/uninstall.php</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span> <span class=o>!</span> <span class=nx>defined</span><span class=p>(</span> <span class=s1>&#39;WP_UNINSTALL_PLUGIN&#39;</span> <span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>sos_uninstall_sos_plugin</span><span class=p>();</span>
</span></span></code></pre></div><p>The uninstall function calls functions to delete custom posts of type
sos and to delete plugin options. If site is multisite and user is super
admin then it call these functions for all sites in the network
otherwise it calls the functions for the site. There is no code to
handle uninstall by non super admins in multisite installation, as site
admins are any way not allowed to install and uninstall plugins at site
level.</p><div>&nbsp;</div><div>&nbsp;</div><p><code>share-on-social/uninstall.php</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>sos_uninstall_sos_plugin</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=nx>function_exists</span><span class=p>(</span> <span class=s1>&#39;is_multisite&#39;</span> <span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>is_multisite</span><span class=p>()</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=k>false</span> <span class=o>==</span> <span class=nx>is_super_admin</span><span class=p>()</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nv>$blogs</span> <span class=o>=</span> <span class=nx>wp_get_sites</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span> <span class=p>(</span> <span class=nv>$blogs</span> <span class=k>as</span> <span class=nv>$blog</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>switch_to_blog</span><span class=p>(</span> <span class=nv>$blog</span><span class=o>&lt;</span><span class=nx>a</span> <span class=nx>href</span><span class=o>=</span><span class=s2>&#34;http://codex.wordpress.org/Class_Reference/WP_Query&#34;</span> <span class=nx>target</span><span class=o>=</span><span class=s2>&#34;_blank&#34;</span><span class=o>&gt;</span> <span class=s1>&#39;blog_id&#39;</span> <span class=p>]</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>sos_delete_sos_posts</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=nx>sos_delete_sos_options</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=nx>restore_current_blog</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=o>!</span> <span class=nx>current_user_can</span><span class=p>(</span> <span class=s1>&#39;activate_plugins&#39;</span> <span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>sos_delete_sos_posts</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>sos_delete_sos_options</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Once Share on Social plugin is deactivated, its custom post type sos no
longer registered but posts of that type may still exist in
<strong>wp_posts</strong> table. In <code>sos_delete_sos_posts()</code>, we use WordPress
function
[WP_Query()</a> to
fetch all posts of type sos and delete them, one by one, using
<a href=http://codex.wordpress.org/Function_Reference/wp_delete_post target=_blank>wp_delete_post()</a>.</p><p><code>share-on-social/uninstall.php</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>sos_delete_sos_posts</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// in multisite uninstall, wp_delete_post access post_type_object and to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// avoid access on non object we register sos post type
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>register_post_type</span><span class=p>(</span> <span class=s1>&#39;sos&#39;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// fetch posts of type sos
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$args</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;post_type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;sos&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nv>$query</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WP_Query</span><span class=p>(</span> <span class=nv>$args</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nv>$query</span><span class=o>-&gt;</span><span class=na>have_posts</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$query</span><span class=o>-&gt;</span><span class=na>the_post</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=s1>&#39;sos&#39;</span> <span class=o>==</span> <span class=nx>get_post_type</span><span class=p>()</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$post_id</span> <span class=o>=</span> <span class=nx>get_the_ID</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=nx>wp_delete_post</span><span class=p>(</span> <span class=nv>$post_id</span><span class=p>,</span> <span class=k>true</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>wp_reset_postdata</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In multisite installation, wp_delete_post() internally uses
<strong>post_type</strong> object and it will thrown an exception when it is unable
to find sos custom type. To overcome this, we temporarily re-register
<strong>sos</strong> custom post type and then proceed with deletion to avoid
warnings in debug.log file.</p><div>&nbsp;</div><div>&nbsp;</div><p>The next chapter explains the nitty-gritty of WordPress Plugin unit
testing.</p></main></div></div><aside id=sidebar-right class=col-md-1><div class="row my-5 justify-content-center"></div></aside></div></div><footer class="container-fluid mt-5"><div class=row><div class="col ml-auto"><div class="row mb-1 ml-2"><a class=text-muted href=/privacy-policy>Privacy</a></div><div class="row text-muted mb-2 ml-2"><span>&copy; 2019 &#183;Powered by <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span></div></div><div class="col mr-auto"><span class=float-right><a href=# id=back_to_top><i class="icon-up-open h1 text-secondary"></i></a></span></div></div></footer><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/js/vendor.min.c32ad1c7e87da9243fe3a4ff30c9040737545641e3a0a16a1cde4d62759f9fea.js></script></body></html>