<!DOCTYPE html>
<html lang="en-us">

<head><meta charset="utf-8">
<meta name="description" content="WordPress Plugin Ajax Unit Test Tutorial explains Ajax testing using Test Library class WP_Ajax_UnitTestCase with proper usage of group and exceptions.">
<meta name="author" content="Maithilish">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-42139846-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-42139846-3');
</script>

<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "http://www.codetab.org/"
        },
        "articleSection" : "tutorial",
        "name" : "Ajax Unit Tests - WordPress Plugin Development - CodeTab",
        "headline" : "Ajax Unit Tests - WordPress Plugin Development - CodeTab",
        "description" : "WordPress Plugin Ajax Unit Test Tutorial explains Ajax testing using Test Library class WP_Ajax_UnitTestCase with proper usage of group and exceptions.",
        "inLanguage" : "en",
        "author" : "Maithilish",
        "creator" : "Maithilish",
        "publisher": "Maithilish",
        "copyrightHolder" : "Maithilish",
        "copyrightYear" : "2019",
        "datePublished": "2019-01-11 13:44:00 +0530 IST",
        "dateModified" : "2019-01-11 13:44:00 +0530 IST",
        "url" : "/tutorial/wordpress-plugin-development/unit-test/ajax/",
        "wordCount" : "1084",
        "keywords" : [ "wordpress plugin ajax unit test","Blog" ]
    }
</script>
<link rel="icon" href="/favicon.ico">





<link rel="stylesheet" href="/css/vendor.min.fda72737edeb853fff288025d5ea04d671489f0f524e38c245ccf83306a19ab3.css" integrity="sha256-/acnN&#43;3rhT//KIAl1eoE1nFInw9STjjCRcz4MwahmrM=">

<title>Ajax Unit Tests - WordPress Plugin Development - CodeTab</title></head>

<body id="top"><header><nav id="navbar-main" class="navbar fixed-top navbar-light navbar-expand-lg bg-white border-bottom shadow-sm">

    <div class="container-fluid">

        
        <a class="navbar-brand" href="/">Codetab</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        
        <div class="collapse navbar-collapse" id="navbar">

            
            
            <ul class="navbar-nav ml-auto">
                

                

                
                
                
                
                

                <li class="nav-item">
                    <a class="nav-link" href="/#tutorials"  >
                        
                        <span>Home</span>
                        
                    </a>
                </li>

                
                

                

                
                
                
                
                

                <li class="nav-item">
                    <a class="nav-link" href="/#projects"  >
                        
                        <span>Projects</span>
                        
                    </a>
                </li>

                
                

                

                
                
                
                
                

                <li class="nav-item">
                    <a class="nav-link" href="/#about"  >
                        
                        <span>About</span>
                        
                    </a>
                </li>

                
                

            </ul>

        </div>
    </div>
</nav></header>

<div class="container-fluid">
  <div class="row">&nbsp;</div>
  <div class="row">
    <aside id="sidebar" class="col-md-4">
      <div class="row"><nav id="navbar-side" class="bg-light text-secondary">
        
    
    

    

    
    

    

    <h4 class="text-muted bg-white pl-2">WP Plugin Development</h4>

    <nav class="navbar navbar-light bg-white navbar-expand-md">

        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#bookmenu"
            aria-controls="bookmenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bookmenu">
            <div>
                
                









<div id="WordPress Plugin Development - CodeTab">
    
    <div>
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/introduction/" class="toc-page text-muted ">
            Introduction
        </a>
    </div>
    
    <div>
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/install-locally/" class="toc-page text-muted ">
            Install Locally
        </a>
    </div>
    
    <div>
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/simple-plugin/" class="toc-page text-muted ">
            Simple Plugin
        </a>
    </div>
    
    <div>
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/shortcode/" class="toc-page text-muted ">
            Shortcode
        </a>
    </div>
    
    <div>
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/plugin-structure/" class="toc-page text-muted ">
            Plugin Structure
        </a>
    </div>
    
    <div>
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/plugin-main-file/" class="toc-page text-muted ">
            Main File
        </a>
    </div>
    
    <div>
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/hooks-actions-filters/" class="toc-page text-muted ">
            Hooks, Actions, Filters
        </a>
    </div>
    
</div>







<div class="dropdown show mt-2">
    <a class="no-collapse-on-click card-link toc-section text-dark" href="#tutorial-wordpress-plugin-development-admin-module-settings" id="dropdownheader"
        data-toggle="collapse" aria-haspopup="true" aria-expanded="false">
        Admin Module - Settings
    </a>
    
    <div id="tutorial-wordpress-plugin-development-admin-module-settings" class="collapse">
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-settings/add-menu/" class="toc-page dropdown-item text-muted">
            Add Menu
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-settings/settings-api/" class="toc-page dropdown-item text-muted">
            Settings API
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-settings/options-page/" class="toc-page dropdown-item text-muted">
            Options Page
        </a>
        
        
        
        
    </div>
</div>




<div class="dropdown show mt-2">
    <a class="no-collapse-on-click card-link toc-section text-dark" href="#tutorial-wordpress-plugin-development-admin-module-custom-posts" id="dropdownheader"
        data-toggle="collapse" aria-haspopup="true" aria-expanded="false">
        Admin Module - Posts
    </a>
    
    <div id="tutorial-wordpress-plugin-development-admin-module-custom-posts" class="collapse">
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-custom-posts/post-type/" class="toc-page dropdown-item text-muted">
            Custom Post Type
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-custom-posts/meta-box/" class="toc-page dropdown-item text-muted">
            Meta Box
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/admin-module-custom-posts/save-post/" class="toc-page dropdown-item text-muted">
            Save Post
        </a>
        
        
        
        
    </div>
</div>




<div class="dropdown show mt-2">
    <a class="no-collapse-on-click card-link toc-section text-dark" href="#tutorial-wordpress-plugin-development-frontend" id="dropdownheader"
        data-toggle="collapse" aria-haspopup="true" aria-expanded="false">
        Frontend
    </a>
    
    <div id="tutorial-wordpress-plugin-development-frontend" class="collapse">
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/frontend/enqueue-scripts/" class="toc-page dropdown-item text-muted">
            Plugin Enqueue Scripts
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/frontend/pass-data-to-javascript/" class="toc-page dropdown-item text-muted">
            Pass Data to JavaScript
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/frontend/debug-info/" class="toc-page dropdown-item text-muted">
            Debug Info
        </a>
        
        
        
        
    </div>
</div>




<div class="dropdown show mt-2">
    <a class="no-collapse-on-click card-link toc-section text-dark" href="#tutorial-wordpress-plugin-development-ajax" id="dropdownheader"
        data-toggle="collapse" aria-haspopup="true" aria-expanded="false">
        Ajax
    </a>
    
    <div id="tutorial-wordpress-plugin-development-ajax" class="collapse">
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/ajax/wordpress-ajax/" class="toc-page dropdown-item text-muted">
            Ajax
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/ajax/chart-page/" class="toc-page dropdown-item text-muted">
            Chart Page
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/ajax/google-charts/" class="toc-page dropdown-item text-muted">
            Google Charts
        </a>
        
        
        
        
    </div>
</div>




<div class="dropdown show mt-2">
    <a class="no-collapse-on-click card-link toc-section text-dark" href="#tutorial-wordpress-plugin-development-internationalization" id="dropdownheader"
        data-toggle="collapse" aria-haspopup="true" aria-expanded="false">
        Internationalization
    </a>
    
    <div id="tutorial-wordpress-plugin-development-internationalization" class="collapse">
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/internationalization/internationalize/" class="toc-page dropdown-item text-muted">
            Internationalization
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/internationalization/localization/" class="toc-page dropdown-item text-muted">
            Localization
        </a>
        
        
        
        
    </div>
</div>




<div class="dropdown show mt-2">
    <a class="no-collapse-on-click card-link toc-section text-dark" href="#tutorial-wordpress-plugin-development-activation" id="dropdownheader"
        data-toggle="collapse" aria-haspopup="true" aria-expanded="false">
        Activation
    </a>
    
    <div id="tutorial-wordpress-plugin-development-activation" class="collapse">
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-activation/" class="toc-page dropdown-item text-muted">
            Activation
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/activation/enable-multisite/" class="toc-page dropdown-item text-muted">
            Multi site
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/activation/multisite-activation/" class="toc-page dropdown-item text-muted">
            Multi site Activation
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-deactivation/" class="toc-page dropdown-item text-muted">
            Deactivation
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/activation/plugin-uninstall/" class="toc-page dropdown-item text-muted">
            Uninstall
        </a>
        
        
        
        
    </div>
</div>




<div class="dropdown show mt-2">
    <a class="no-collapse-on-click card-link toc-section text-dark" href="#tutorial-wordpress-plugin-development-unit-test" id="dropdownheader"
        data-toggle="collapse" aria-haspopup="true" aria-expanded="false">
        Testing
    </a>
    
    <div id="tutorial-wordpress-plugin-development-unit-test" class="">
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/plugin-unit-testing/" class="toc-page dropdown-item text-muted">
            Unit Test
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/setup/" class="toc-page dropdown-item text-muted">
            Test Setup
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/simple-unit-tests/" class="toc-page dropdown-item text-muted">
            Simple Unit Tests
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/scripts-actions-filters/" class="toc-page dropdown-item text-muted">
            Unit Test Scripts, Actions, Filters
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/advanced-unit-tests/" class="toc-page dropdown-item text-muted">
            Advanced Unit Tests
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/internationalization-functions/" class="toc-page dropdown-item text-muted">
            Test Internationalization Functions
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/ajax/" class="toc-page dropdown-item text-danger">
            Ajax Unit Tests
        </a>
        
        
        <a href="http://www.codetab.org/tutorial/wordpress-plugin-development/unit-test/multisite-plugin-unit-tests/" class="toc-page dropdown-item text-muted">
            Multi site Plugin Unit Tests
        </a>
        
        
        
        
    </div>
</div>



                
            </div>
        </div>
    </nav>

</nav>

</div>
      <div class="row my-5 justify-content-center">
<div>&nbsp;</div>


<ins class="adsbygoogle"
     style="display:inline-block;width:160px;height:600px"
     data-ad-client="ca-pub-1281079745125126"
     data-ad-slot="8963022093"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<div>&nbsp;</div>
</div>
    </aside>
    <main id="content" class="col-md-8 post-basic">
      

<h2 id="12-7-wordpress-plugin-ajax-unit-tests">12.7.Â WordPress Plugin Ajax Unit Tests</h2>

<p>In the previous six blogs, we gone through the unit tests for the
WordPress plugin regular methods. In this blog, we explore WordPress
Plugin Ajax unit tests.</p>

<p>The normal test cases extend <code>WP_UnitTestCase</code>. For Ajax unit tests,
WordPress Test Library comes with a separate class
WP_Ajax_UnitTestCase. Moreover, the construction of the test methods
are also bit different from the regular ones.</p>

<h3 id="ajax-test-case-group-and-files">Ajax Test Case Group and Files</h3>

<p>While normal test cases takes very little time to complete, WordPress
Plugin Ajax tests are inherently very slow. Hence, it is not practical
to run Ajax tests along with other tests.</p>

<p>Taking this into account, WordPress Tests uses PHPUnit annotation @group
to group the Ajax tests. In phpunit.xml, use &lt;exclude/&gt; to exclude the
Ajax test group during normal test run.</p>

<p><code>wp-simple-plugin/phpunit.xml</code></p>
<div class="highlight"><pre class="chroma"><code class="language-XML" data-lang="XML"><span class="nt">&lt;phpunit</span> <span class="na">bootstrap=</span><span class="s">&#34;tests/phpunit/bootstrap.php&#34;</span>   <span class="na">backupGlobals=</span><span class="s">&#34;false&#34;</span>
    <span class="na">colors=</span><span class="s">&#34;false&#34;</span> <span class="na">convertErrorsToExceptions=</span><span class="s">&#34;true&#34;</span>
    <span class="na">convertNoticesToExceptions=</span><span class="s">&#34;true&#34;</span> <span class="na">convertWarningsToExceptions=</span><span class="s">&#34;true&#34;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;testsuites&gt;</span>
    <span class="nt">&lt;testsuite&gt;</span>
        .... test files
    <span class="nt">&lt;/testsuite&gt;</span>
  <span class="nt">&lt;/testsuites&gt;</span>

  <span class="nt">&lt;groups&gt;</span>
    <span class="nt">&lt;exclude&gt;</span>
       <span class="nt">&lt;group&gt;</span>ajax<span class="nt">&lt;/group&gt;</span>
    <span class="nt">&lt;/exclude&gt;</span>
  <span class="nt">&lt;/groups&gt;</span>

<span class="nt">&lt;/phpunit&gt;</span></code></pre></div>
<figure class="text-center" >
  <img class="lazy" data-src="/tutorial/wordpress-plugin-development/media/wp-pd-sos-ut-ajax-files.png" alt="WordPress Plugin Ajax Unit Tests - ajax test files" />
</figure>


<p>In Share on Social Plugin, the Ajax methods are defined in <code>Sos_Ajax</code>
class of <code>share-on-social/admin/class-ajax.php</code>. But, this class also
contains some methods which are non Ajax and running them along with the
Ajax methods slows the test run further. To overcome that, the tests for
Sos_Ajax is split into two test files.</p>

<ul>
<li><p>test-ajax.php - defines class <code>Test_Sos_Ajax</code> class which extends
<code>WP_Ajax_UnitTestCase</code> and contains tests for Ajax methods.</p></li>

<li><p>test-ajax-others.php - defines class <code>Test_Sos_Ajax_others</code> class
which extends <code>WP_UnitTestCase</code> and contains tests for non Ajax
methods of Sos_Ajax.</p></li>
</ul>

<h3 id="wordpress-ajax-test-case">WordPress Ajax Test Case</h3>

<p>Let&rsquo;s go through <code>Test_Sos_Ajax</code> to understand how Ajax Test Case is
defined.</p>

<p><code>share-on-social/tests/phpunit/tests/test-ajax.php</code></p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="sd">/**
</span><span class="sd">*  !!!! ONLY FOR AJAX CALL !!!!
</span><span class="sd">*  
</span><span class="sd">* Tests for the Ajax calls to save and get sos stats. 
</span><span class="sd">* For speed, non ajax calls of class-ajax.php are tested in test-ajax-others.php
</span><span class="sd">* Ajax tests are not marked risky when run in separate processes and wp_debug 
</span><span class="sd">* disabled. But, this makes tests slow so non ajax calls are kept separate
</span><span class="sd">* 
</span><span class="sd">* @group ajax
</span><span class="sd">* @runTestsInSeparateProcesses
</span><span class="sd">*  
</span><span class="sd">*/</span>
<span class="k">class</span> <span class="nc">Test_Sos_Ajax</span> <span class="k">extends</span> <span class="nx">WP_Ajax_UnitTestCase</span> <span class="p">{</span>

    <span class="k">var</span> <span class="nv">$sos_ajax</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setup</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">setup</span><span class="p">();</span>
        
        <span class="k">require_once</span> <span class="s1">&#39;admin/class-ajax.php&#39;</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sos_ajax</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sos_Ajax</span><span class="p">();</span>
        
        <span class="nx">wp_set_current_user</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">teardown</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">teardown</span><span class="p">();</span>
        <span class="nx">unload_textdomain</span><span class="p">(</span> <span class="s1">&#39;sos-domain&#39;</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="o">....</span>
<span class="p">}</span>
</code></pre></div>
<p>For Ajax test case, in the header comments, we add two annotations. The
annotation, <strong>@group ajax</strong> adds the test methods of this class to a
group named ajax. The second annotation,
<strong>@runTestsInSeparateProcesses</strong> tells PHPUnit to run each test from
this class in a separate process.</p>

<p>The command to run normal and Ajax tests are as follows.</p>
<div class="highlight"><pre class="chroma"><code class="language-screen" data-lang="screen">To Run NORMAL Tests 

$ phpunit


To Run AJAX Tests

$ phpunit --group ajax</code></pre></div>
<p>During normal run, Test_Sos_Ajax_Others is included with other test
files of the plugin, however, in Ajax test run, only tests from
Test_Sos_Ajax are executed as the class is annotated with <strong>@group
ajax</strong>.</p>

<p><strong>Risky Tests</strong></p>

<p>PHPUnit marks some of the Ajax tests status as <strong>R</strong>. The tests are
marked as Risky because they fail to close PHP buffer properly.</p>

<p>We couldn&rsquo;t find out what exactly causes of this. Workaround to the
buffer issue is to run Ajax tests in separate process. Tests are not
marked as Risky when Ajax Test class is annotated with
@runTestsInSeparateProcesses, though it drastically slows down the test
run.</p>

<h3 id="wordpress-ajax-tests">WordPress Ajax Tests</h3>

<p>For Ajax, the test construction is quite different from the normal ones.
Let&rsquo;s go through some Ajax tests to understand how it is done.</p>

<p>The Ajax method <code>Sos_Ajax::save_stats()</code> obtains data from PHP global
$_POST and saves the details in WordPress Option and returns 1 as
success flag.</p>

<p><code>share-on-social/admin/class-ajax.php</code></p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">    public function save_stats () {
        $valid_req = check_ajax_referer( &#39;sos-save-stat&#39;, false, false );
        if ( false == $valid_req ) {
            wp_die( &#39;-1&#39; );
        }
        
        if ( ! isset( $_POST[ &#39;type&#39; ] ) || ! isset( $_POST[ &#39;share_name&#39; ] ) ) {
            wp_die( &#39;-1&#39; );
        }
        $share_on = $_POST[ &#39;type&#39; ];
        $share_name = $_POST[ &#39;share_name&#39; ];
        
        $this-&gt;update_sos_stats( $share_on, $share_name );
        $this-&gt;update_sos_stats_summary( $share_on, $share_name );
        
        wp_die( &#39;1&#39; );
    }</code></pre></div>
<p>To test it, we use test method <code>Test_Sos_Ajax::test_save_stat_stats()</code>.</p>

<p><code>share-on-social/tests/phpunit/tests/test-ajax.php</code></p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">    public function test_save_stat_stats () {
        global $_POST;
        $_POST[ &#39;type&#39; ] = &#39;fb&#39;;
        $_POST[ &#39;share_name&#39; ] = &#39;test&#39;;
        $_POST[ &#39;_wpnonce&#39; ] = wp_create_nonce( &#39;sos-save-stat&#39; );
        
        try {
            $this-&gt;sos_ajax-&gt;setup();
            $this-&gt;_handleAjax( &#39;save-stats&#39; );
        } catch (WPAjaxDieStopException $e) {}
        
        $this-&gt;assertTrue( isset( $e ) );
        $this-&gt;assertEquals( &#39;1&#39;, $e-&gt;getMessage() );
        
        $stats = get_option( &#39;sos_stats&#39; );
        $this-&gt;assertCount( 1, $stats );
        
        $stat = $stats[ 0 ];
        
        $this-&gt;assertSame( &#39;fb&#39;, $stat[ &#39;type&#39; ] );
        $this-&gt;assertSame( &#39;test&#39;, $stat[ &#39;share_name&#39; ] );
    }</code></pre></div>
<p>After loading the data in $_POST, the test in a try-catch block, calls
<code>Sos_Ajax::setup()</code> method which wires Ajax on server side as explained
in <a href="/tutorial/wordpress-plugin-development/ajax/wordpress-ajax/">WordPress Ajax</a>. Next, Ajax call is made using <code>WP_Ajax_UnitTestCase::_handleAjax()</code> by passing
Ajax handler <strong>save-stats</strong> as the parameter. The exception
<code>WPAjaxDieStopException</code> catches the outcome of Ajax call which is
assigned to variable <code>$e</code>.</p>

<p>Ajax call return value is obtained from $e-&gt;getMessage() and tested
whether call is successful. Since, Ajax method saves the stat in
WordPress option, we obtain the data using WordPress function
get_option() and test it.</p>

<p>The above Ajax method sends 1 or -1 as return value. But, there are
other types of Ajax method which returns data instead of a flag. One
such method is <code>Sos_Ajax::get_stats()</code> which returns stats as JSON
string to the client.</p>

<p><code>share-on-social/tests/phpunit/tests/test-ajax.php</code></p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">    public function test_get_stats_single_stat () {
        global $_POST;
        $_POST[ &#39;_wpnonce&#39; ] = wp_create_nonce( &#39;sos-get-stats&#39; );
        
        $test_stats = $this-&gt;get_test_stats();
        $stats[] = $test_stats[ 0 ];
        add_option( &#39;sos_stats&#39;, $stats );
        
        try {
            $this-&gt;sos_ajax-&gt;setup();
            $this-&gt;_handleAjax( &#39;get-stats&#39; );
        } catch (WPAjaxDieStopException $e) {}
        
        $this-&gt;assertTrue( isset( $e ) );
        $result = $e-&gt;getMessage();
        $expected = &#39;{&#34;cols&#34;:[{&#34;label&#34;:&#34;Date&#34;,&#34;type&#34;:&#34;date&#34;},{&#34;label&#34;:&#34;FB&#34;,&#34;type&#34;:&#34;number&#34;}],&#34;rows&#34;:[{&#34;c&#34;:[{&#34;v&#34;:&#34;Date(2014,9,29)&#34;},{&#34;v&#34;:1}]}]}&#39;;
        $this-&gt;assertSame( $expected, $result );
    }</code></pre></div>
<p>The test is similar to previous one, but here <code>$e-&gt;getMessage()</code> returns
the JSON string returned by the Ajax call.</p>

<h3 id="exception-types-and-die">Exception Types and Die</h3>

<p>To terminate Ajax methods, in Chapter <a href="/tutorial/wordpress-plugin-development/ajax/wordpress-ajax/">WordPress Ajax</a>, we
suggested to use <a href="http://codex.wordpress.org/Function_Reference/wp_die" target="_blank">wp_die()</a> instead of die() or exit(). Reason being, die() kills the test process even before the test completes, whereas wp_die() continues with test execution which allows WordPress to handle the output through a dedicated die handler.</p>

<p>WordPress Ajax method can end with four states.</p>

<ul>
<li><p>Without output or return value.</p></li>

<li><p>With output or return value.</p></li>

<li><p>Error condition without return value.</p></li>

<li><p>Error condition with return value.</p></li>
</ul>

<p>To handle these states, WP_Ajax_UnitTestCase supports two types of
exception.</p>

<ul>
<li><p><code>WPAjaxDieStopException</code> - for use with Ajax calls that returns or
output data or status.</p></li>

<li><p><code>WPAjaxDieContinueException</code> - for use with Ajax calls that never
return data or status.</p></li>
</ul>

<p>In Share on Social Plugin, we use <code>wp_die()</code> to return data or status
and so, the plugins&rsquo; tests always use <code>WPAjaxDieStopException</code>.</p>

<p>In the next blog, we explain the configuration and tests for WordPress
Multisite.</p>

    </main>
  </div>
</div>

<footer class="container-fluid mt-5">

    <div class="row">
        <div class="col ml-auto">
            <div class="row mb-1 ml-2">
                <a class="text-muted" href="/privacy-policy">Privacy</a>
            </div>
            <div class="row text-muted mb-2 ml-2">
                <span>&copy; 2019 &middot;Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
            </div>
        </div>
        <div class="col mr-auto">
            <span class="float-right">
                <a href="#" id="back_to_top">
                    <img src="/icon/arrow-up.png" alt="Back to Top">
                </a>
            </span>
        </div>
    </div>

</footer>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>







<script src="/js/vendor.min.d5750c855207aebcf4fdb7568961a27500008ef4a4f40b63a7b028f80a9221d3.js"></script>
</body>

</html>