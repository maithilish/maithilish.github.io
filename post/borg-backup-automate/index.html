<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=description content="Pybs is simple yet quite effective Python script to automate multiple backups using Borg Backup software."><meta name=author content="Maithilish"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYHTHXW09H"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYHTHXW09H")</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://google.com/article"},"articleSection":"post","name":"Automate Borg Backup","headline":"Automate Borg Backup","url":"https://www.codetab.org/post/borg-backup-automate/","description":"Pybs is simple yet quite effective Python script to automate multiple backups using Borg Backup software.","inLanguage":"en","image":"https://www.codetab.org/logo.jpg","author":"Maithilish","creator":"Maithilish","publisher":{"@type":"Organization","name":"Maithilish","url":"https://www.codetab.org/","logo":{"@type":"ImageObject","url":"https://www.codetab.org/logo.png","width":"200","height":"200"}},"copyrightHolder":"Maithilish","copyrightYear":"2019","datePublished":"2019-08-27T11:00:00Z","dateModified":"2019-08-27T11:00:00Z","wordCount":"683","keywords":["borg backup automate python script","Blog"]}</script><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/vendor.min.b34f4a49e8fbf83dd7dd8f945eb35a939c19aa15051f677ac5a9c057ac6c8774.css integrity="sha256-s09KSej7+D3X3Y+UXrNak5wZqhUFH2d6xanAV6xsh3Q="><title>Automate Borg Backup</title>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1281079745125126" crossorigin=anonymous></script></head><body id=top><header><nav id=navbar-main class="navbar fixed-top navbar-light navbar-expand-lg bg-white border-bottom shadow-sm"><div class=container-fluid><a class=navbar-brand href=/>Codetab</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbar aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbar><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/#tutorials><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/post><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#about><span>About</span></a></li></ul></div></div></nav></header><div class=container-fluid><div class=row>&nbsp;</div><div class=row><div id=contentspace class="col-md-8 post-basic order-md-2"><h2>Automate Borg Backup</h2><small class=text-muted>Aug 27, 2019 . 4 min read</small><div id=share class="row mx-0 justify-content-end"><div title=twitter><a href="https://twitter.com/intent/tweet?url=https://www.codetab.org/post/borg-backup-automate/&amp;text=Automate%20Borg%20Backup" target=_blank rel=noopener><i class="icon-twitter-squared text-secondary"></i></a></div><div title=facebook><a href="https://www.facebook.com/sharer.php?u=https://www.codetab.org/post/borg-backup-automate/&amp;t=Automate%20Borg%20Backup" target=_blank rel=noopener><i class="icon-facebook-squared text-secondary"></i></a></div><div title=linkedin><a href="https://www.linkedin.com/shareArticle?url=https://www.codetab.org/post/borg-backup-automate/&amp;title=Automate%20Borg%20Backup" target=_blank rel=noopener><i class="icon-linkedin-squared text-secondary"></i></a></div><div title=email><a href="mailto:?subject=Automate%20Borg%20Backup&amp;body=https://www.codetab.org/post/borg-backup-automate/" target=_blank rel=noopener><i class="icon-mail-squared text-secondary"></i></a></div><div title=whatsapp><a href="https://web.whatsapp.com/send?text=Automate%20Borg%20Backup%20https://www.codetab.org/post/borg-backup-automate/" target=_blank rel=noopener><i class="icon-whatsapp text-secondary"></i></a></div><div title=reddit><a href="https://reddit.com/submit?url=https://www.codetab.org/post/borg-backup-automate/&amp;title=Automate%20Borg%20Backup" target=_blank rel=noopener><i class="icon-reddit-alien text-secondary"></i></a></div><i class="icon-blank ctab-transparent"></i></div><hr class=my-3><main id=content class=post-basic><p>The previous post, <a href=/post/borg-backup/>Borg Backup<a>, explained installation and basics of Borg, and this post introduces <code>Pybs</code>, a simple python script to automate backups in Linux systems. To automate the backups, <code>Pybs</code> uses <code>P</code>ython, <code>Y</code>AML, <code>B</code>org and <code>S</code>ystemd. For non-linux platforms use some other task scheduler in place of Systemd.</p><h2 id=installation>Installation</h2><p>Download Pybs from <a href=https://github.com/maithilish/codefs/raw/master/pybs/pybs.zip>Github</a> and extract it in your home dir.</p><p>Pybs, by default, uses Borg repository at <code>$HOME/backup/borgrepo</code> located in user home directory. However, for actual backup, the repository should be located in a separate disk or device, otherwise the backup is lost in case of system failure.</p><p>To run, Pybs needs Python 3 and Python YAML. Install them with,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo apt install python3 python-yaml
</span></span><span class=line><span class=cl> 
</span></span></code></pre></div><h2 id=pybs-setup>Pybs Setup</h2><p>In Pybs config files, the paths are hard-coded as <code>/home/m</code>. Edit the following files and change all occurrences of <code>/home/m</code> to absolute path of your home directory.</p><pre tabindex=0><code class=language-Screen data-lang=Screen>    
pybs/backup.yaml

pybs/systemd/pybs-daily.env
pybs/systemd/pybs-daily.service

pybs/systemd/pybs-weekly.env
pybs/systemd/pybs-weekly.service
    
</code></pre><p>Let&rsquo;s run Pybs and do some backup. We will explain the Pybs configuration bit later.</p><p><a id=runpybs></a></p><h2 id=run-pybs-as-normal-user>Run Pybs as normal user</h2><p>First, create Borg repository,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> <span class=nv>$HOME</span>
</span></span><span class=line><span class=cl>$ mkdir backup
</span></span><span class=line><span class=cl>$ borg init -e none backup/borgrepo
</span></span><span class=line><span class=cl>    
</span></span></code></pre></div><p>Next, setup systemd daily backup.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>$ mkdir -p .config/systemd/user
</span></span><span class=line><span class=cl>$ cp pybs/systemd/*.service .config/systemd/user
</span></span><span class=line><span class=cl>$ systemctl --user daemon-reload
</span></span><span class=line><span class=cl>        
</span></span></code></pre></div><p>To run Pybs service as normal user, create <code>$HOME/.config/systemd/user</code> dir and copy systemd service files to it. After reloading systemd daemon, start pybs-daily service. Wait for sometime and see the backup status with,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ systemctl --user start pybs-daily    
</span></span><span class=line><span class=cl>$ systemctl --user status pybs-daily
</span></span><span class=line><span class=cl> 
</span></span></code></pre></div><p>Once backup status repots success, check the backup in repo</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>$ borg list backup/borgrepo
</span></span><span class=line><span class=cl> 
</span></span></code></pre></div><p>Now you can enable timer and to do that copy and start timer files with,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>$ cp pybs/systemd/*.timer .config/systemd/user/
</span></span><span class=line><span class=cl>$ systemctl --user daemon-reload
</span></span><span class=line><span class=cl>$ systemctl --user <span class=nb>enable</span> pybs-daily.timer
</span></span><span class=line><span class=cl>$ systemctl --user start pybs-daily.timer    
</span></span><span class=line><span class=cl>$ systemctl --user list-timers
</span></span><span class=line><span class=cl>    
</span></span></code></pre></div><h2 id=run-pybs-as-super-user>Run Pybs as super user</h2><p>To backup system wide files and directories, run systemd scripts and timers as root. For that, first create Borg repository as explained above and then place service and timer files in <code>/etc/systemd/system</code> dir as,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo cp pybs/systemd/*.service /etc/systemd/system
</span></span><span class=line><span class=cl>$ sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>$ sudo systemctl start pybs-daily
</span></span><span class=line><span class=cl>$ sudo systemctl status pybs-daily
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## timer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo cp pybs/systemd/*.timer /etc/systemd/system
</span></span><span class=line><span class=cl>$ sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>$ sudo systemctl <span class=nb>enable</span> pybs-daily.timer
</span></span><span class=line><span class=cl>$ sudo systemctl start pybs-daily.timer
</span></span><span class=line><span class=cl>$ sudo systemctl list-timers
</span></span><span class=line><span class=cl>    
</span></span></code></pre></div><h2 id=pybs-configuration>Pybs Configuration</h2><p>To understand Pybs configuration, let&rsquo;s create a new monthly backup service. In <code>pybs/systemd</code> dir, create a new env file and name it as you like with following content,</p><p><code>pybs/systemd/pybs-monthly.env</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=nv>REPO_PATH</span><span class=o>=</span>/home/m/backup/borgrepo
</span></span><span class=line><span class=cl><span class=nv>BASE_DIR</span><span class=o>=</span>/home/m/pybs
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=nv>BACKUP_LIST</span><span class=o>=</span>backup.yml    
</span></span><span class=line><span class=cl><span class=nv>LABEL</span><span class=o>=</span>foo
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>DELAY_START_SEC</span><span class=o>=</span><span class=m>120</span>
</span></span><span class=line><span class=cl>        
</span></span></code></pre></div><p>Point environment variable REPO_PATH to absolute path of your borg repository and the BASE_DIR is absolute path of your pybs directory. The BACKUP_LIST is the name of the yaml file which specifies the list of directories or files to backup. The LABEL can be named anything and pybs use it select backups from the list file which has same label. For example, if label is <code>foo</code> then pybs selects only the items labeled as <code>foo</code> for backup. The DELAY_START_SEC is useful to delay the backup so as to reduce the load at the system startup.</p><p>Next, create systemd service file, which you may name as you like, in <code>pybs/systemd</code>.</p><p><code>pybs/systemd/pybs-monthly.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>Borg Monthly Backup Service
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Type</span><span class=o>=</span>simple
</span></span><span class=line><span class=cl><span class=nv>Nice</span><span class=o>=</span><span class=m>19</span>
</span></span><span class=line><span class=cl><span class=nv>IOSchedulingClass</span><span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl><span class=nv>IOSchedulingPriority</span><span class=o>=</span><span class=m>7</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=nv>EnvironmentFile</span><span class=o>=</span>/home/m/pybs/systemd/pybs-monthly.env
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/bin/bash -c <span class=s1>&#39;${BASE_DIR}/script/backup.sh&#39;</span>
</span></span></code></pre></div><p>Set <code>EnvironmentFile</code> variable to absolute path of env file which you have created. Leave all other things as it is.</p><p>We also need a systemd timer.</p><p><code>pybs/systemd/pybs-monthly.timer</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>Borg Monthly Backup Timer
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=o>[</span>Timer<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>OnCalendar</span><span class=o>=</span>monthly
</span></span><span class=line><span class=cl><span class=nv>AccuracySec</span><span class=o>=</span>1h
</span></span><span class=line><span class=cl><span class=nv>Persistent</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>timers.target
</span></span></code></pre></div><p>The file should be named same as service file base name, but with .timer extension. The backup frequency is set with <code>OnCalendar</code> variable. Refer systemd documentation to know more about timers.</p><p>Finally, add backup entries for monthly backup. Label the backup sets with the label specified in env file.</p><p><code>pybs/backup.yml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-YAML data-lang=YAML><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>backups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>music</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>label</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dirs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/home/m/Music</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>excludes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/home/m/Music/*.wmv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>picts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>label</span><span class=p>:</span><span class=w> </span><span class=l>weekly</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dirs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/home/m/Pictures</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span></code></pre></div><p>The new backup service backups only the Music dir excluding all wmv files.</p><p>Thats all there is to configure. To run new backup service, copy and enable service and timer units as explained in <a href=#runpybs>Run Pybs</a></p></main></div><aside id=sidebar class="col-md-3 order-md-1"><div class="row my-5 justify-content-center"></div></aside><aside id=sidebar-right class="col-md-1 order-md-last"></aside></div></div><footer class="container-fluid mt-5"><div class=row><div class="col ml-auto"><div class="row mb-1 ml-2"><a class=text-muted href=/privacy-policy>Privacy</a></div><div class="row text-muted mb-2 ml-2"><span>&copy; 2019 &#183;Powered by <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span></div></div><div class="col mr-auto"><span class=float-right><a href=# id=back_to_top><i class="icon-up-open h1 text-secondary"></i></a></span></div></div></footer><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/js/vendor.min.53a9c8fc3cce9658f4d62a893cd70a0b064ffeb53a74a5c776889aea89eaf65a.js></script></body></html>