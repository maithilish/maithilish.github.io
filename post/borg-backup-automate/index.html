<!DOCTYPE html>
<html lang="en-us">

<head><meta charset="utf-8">
<meta name="description" content="Pybs is simple yet quite effective Python script to automate multiple backups using Borg Backup software.">
<meta name="author" content="Maithilish">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-42139846-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-42139846-3');
</script>

<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https:\/\/www.codetab.org\/"
        },
        "articleSection" : "post",
        "name" : "Automate Borg Backup",
        "headline" : "Automate Borg Backup",
        "description" : "Pybs is simple yet quite effective Python script to automate multiple backups using Borg Backup software.",
        "inLanguage" : "en",
        "author" : "Maithilish",
        "creator" : "Maithilish",
        "publisher": "Maithilish",
        "copyrightHolder" : "Maithilish",
        "copyrightYear" : "2019",
        "datePublished": "2019-08-27T11:00:00Z",
        "dateModified" : "2019-08-27T11:00:00Z",
        "url" : "\/post\/borg-backup-automate\/",
        "wordCount" : "645",
        "keywords" : [ "borg backup automate python script","Blog" ]
    }
</script>
<link rel="icon" href="/favicon.ico">






<link rel="stylesheet" href="/css/vendor.min.5094155807f5e8e42efd4efe08a15d3c51025b1e28787bdea850902bf7650261.css" integrity="sha256-UJQVWAf16OQu/U7&#43;CKFdPFECWx4oeHveqFCQK/dlAmE=">

<title>Automate Borg Backup</title></head>

<body id="top"><header><nav id="navbar-main" class="navbar fixed-top navbar-light navbar-expand-lg bg-white border-bottom shadow-sm">

    <div class="container-fluid">

        
        <a class="navbar-brand" href="/">Codetab</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        
        <div class="collapse navbar-collapse" id="navbar">

            
            
            <ul class="navbar-nav ml-auto">
                

                

                
                
                
                
                

                <li class="nav-item">
                    <a class="nav-link" href="/#tutorials"  >
                        
                        <span>Home</span>
                        
                    </a>
                </li>

                
                

                

                
                
                
                
                

                <li class="nav-item">
                    <a class="nav-link" href="/#projects"  >
                        
                        <span>Projects</span>
                        
                    </a>
                </li>

                
                

                

                
                
                

                <li class="nav-item">
                    <a class="nav-link" href="/post"  >
                        
                        <span>Posts</span>
                        
                    </a>
                </li>

                
                

                

                
                
                
                
                

                <li class="nav-item">
                    <a class="nav-link" href="/#about"  >
                        
                        <span>About</span>
                        
                    </a>
                </li>

                
                

            </ul>

        </div>
    </div>
</nav></header>

<div class="container-fluid">
  <div class="row">&nbsp;</div>
  <div class="row">
    <aside id="sidebar" class="col-md-3">
      <div class="row my-5 justify-content-center">
<div>&nbsp;</div>


<ins class="adsbygoogle"
     style="display:inline-block;width:160px;height:600px"
     data-ad-client="ca-pub-1281079745125126"
     data-ad-slot="8963022093"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<div>&nbsp;</div>
</div>
    </aside>

    <div id="contentspace" class="col-md-7 post-basic">
      <h2>Automate Borg Backup</h2>
      <small class="text-muted">
        Aug 27, 2019 . 4 min read
      </small>
      <div id="share" class="row mx-0 justify-content-end">





<div title=twitter>
    <a href="https://twitter.com/intent/tweet?url=https://www.codetab.org/post/borg-backup-automate/&amp;text=Automate%20Borg%20Backup" target="_blank" rel="noopener">
        <i class="icon-twitter-squared text-secondary"></i>
    </a>
</div>




<div title=facebook>
    <a href="https://www.facebook.com/sharer.php?u=https://www.codetab.org/post/borg-backup-automate/&amp;t=Automate%20Borg%20Backup" target="_blank" rel="noopener">
        <i class="icon-facebook-squared text-secondary"></i>
    </a>
</div>




<div title=linkedin>
    <a href="https://www.linkedin.com/shareArticle?url=https://www.codetab.org/post/borg-backup-automate/&amp;title=Automate%20Borg%20Backup" target="_blank" rel="noopener">
        <i class="icon-linkedin-squared text-secondary"></i>
    </a>
</div>




<div title=email>
    <a href="mailto:?subject=Automate%20Borg%20Backup&amp;body=https://www.codetab.org/post/borg-backup-automate/" target="_blank" rel="noopener">
        <i class="icon-mail-squared text-secondary"></i>
    </a>
</div>




<div title=whatsapp>
    <a href="https://web.whatsapp.com/send?text=Automate%20Borg%20Backup%20https://www.codetab.org/post/borg-backup-automate/" target="_blank" rel="noopener">
        <i class="icon-whatsapp text-secondary"></i>
    </a>
</div>




<div title=reddit>
    <a href="https://reddit.com/submit?url=https://www.codetab.org/post/borg-backup-automate/&amp;title=Automate%20Borg%20Backup" target="_blank" rel="noopener">
        <i class="icon-reddit-alien text-secondary"></i>
    </a>
</div>




<div title=weibo>
    <a href="https://service.weibo.com/share/share.php?url=https://www.codetab.org/post/borg-backup-automate/&amp;title=Automate%20Borg%20Backup" target="_blank" rel="noopener">
        <i class="icon-weibo text-secondary"></i>
    </a>
</div>




<i class="icon-blank ctab-transparent"></i></div>
      <hr class="my-3" />
      <main id="content" class="post-basic">
        

<p>The previous post, <a href="/post/borg-backup/">Borg Backup<a>, explained installation and basics of Borg, and this post introduces <code>Pybs</code>, a simple python script to automate backups in Linux systems. To automate the backups, <code>Pybs</code> uses <code>P</code>ython, <code>Y</code>AML, <code>B</code>org and <code>S</code>ystemd. For non-linux platforms use some other task scheduler in place of Systemd.</p>

<h2 id="installation">Installation</h2>

<p>Download Pybs from <a href="https://github.com/maithilish/codefs/raw/master/pybs/pybs.zip">Github</a> and extract it in your home dir.</p>

<p>Pybs, by default, uses Borg repository at <code>$HOME/backup/borgrepo</code> located in user home directory, and for sake of explanation, we stick with it. However, for actual backup, the repository should be located in a separate disk or device, otherwise the backup is lost in case of system failure.</p>

<p>To run, Pybs needs Python and Python YAML. Install them with,</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">$ sudo apt install python python-yaml</code></pre></div>
<h2 id="pybs-setup">Pybs Setup</h2>

<p>In all files, the paths are hard-coded as <code>/home/x</code>. Edit files listed below and change all occurrences of <code>/home/x</code> to absolute path of your home directory.</p>
<div class="highlight"><pre class="chroma"><code class="language-Screen" data-lang="Screen">    
pybs/backup.yaml

pybs/systemd/pybs-daily.env
pybs/systemd/pybs-daily.service

pybs/systemd/pybs-weekly.env
pybs/systemd/pybs-weekly.service
    </code></pre></div>
<p>We explain the Pybs configuration bit later. Let&rsquo;s run Pybs and do some backup.</p>

<p><a id="runpybs"></a></p>

<h2 id="run-pybs-as-normal-user">Run Pybs as normal user</h2>

<p>Create Borg repository with,</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">    
$ <span class="nb">cd</span> <span class="nv">$HOME</span>
$ mkdir backup
$ borg init -e none backup/borgrepo
    </code></pre></div>
<p>Next, setup systemd daily backup.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">    
$ mkdir -p .config/systemd/user
$ cp pybs/systemd/*.service .config/systemd/user
$ systemctl --user daemon-reload
$ systemctl --user start pybs-daily
        </code></pre></div>
<p>To run Pybs service as normal user, create <code>$HOME/.config/systemd/user</code> dir and copy systemd service files to it. After reloading systemd daemon, start pybs-daily service. Wait for sometime and see the backup status with,</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">    
$ systemctl --user status pybs-daily
        </code></pre></div>
<p>To enable timer, copy and start timer files with,</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">    
$ cp pybs/systemd/*.timer .config/systemd/user/
$ systemctl --user daemon-reload
$ systemctl --user <span class="nb">enable</span> pybs-daily.timer
$ systemctl --user start pybs-daily.timer    
$ systemctl --user list-timers
    </code></pre></div>
<h2 id="run-pybs-as-super-user">Run Pybs as super user</h2>

<p>To backup system wide files and directories, run systemd scripts and timers as root. For that, first create Borg repository as explained above and then place service and timer files in <code>/etc/systemd/system</code> dir as,</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash"><span class="c1">## service</span>

$ cp pybs/systemd/*.service /etc/systemd/system
$ systemctl daemon-reload
$ systemctl start pybs-daily
$ systemctl status pybs-daily    

<span class="c1">## timer</span>

$ cp pybs/systemd/*.timer /etc/systemd/system
$ systemctl daemon-reload
$ systemctl <span class="nb">enable</span> pybs-daily.timer
$ systemctl start pybs-daily.timer
$ systemctl list-timers    
    </code></pre></div>
<h2 id="pybs-configuration">Pybs Configuration</h2>

<p>Let&rsquo;s create a new monthly backup service to know Pybs configuration. In <code>pybs/systemd</code> dir, create a new env file and name it as you like with following content,</p>

<p><code>pybs/systemd/pybs-monthly.env</code></p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">    
<span class="nv">REPO_PATH</span><span class="o">=</span>/home/x/backup/borgrepo
<span class="nv">BASE_DIR</span><span class="o">=</span>/home/x/pybs
    
<span class="nv">BACKUP_LIST</span><span class="o">=</span>backup.yml    
<span class="nv">LABEL</span><span class="o">=</span>foo

<span class="nv">DELAY_START_SEC</span><span class="o">=</span><span class="m">120</span>
        </code></pre></div>
<p>Point environment variable REPO_PATH to absolute path of your borg repository and the BASE_DIR is absolute path of your pybs directory. The BACKUP_LIST is the name of the yaml file which specifies the list of directories or files to backup. The LABEL can be named anything and pybs use it select backups from the list file which has same label. For example, if label is <code>foo</code> then pybs selects only the items labeled as <code>foo</code> for backup. The DELAY_START_SEC is useful to delay the backup so as to reduce the load at the system startup.</p>

<p>Next, create systemd service file, which you may name as you like, in <code>pybs/systemd</code>.</p>

<p><code>pybs/systemd/pybs-monthly.service</code></p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">    
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Borg Monthly Backup Service
    
<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">Type</span><span class="o">=</span>simple
<span class="nv">Nice</span><span class="o">=</span><span class="m">19</span>
<span class="nv">IOSchedulingClass</span><span class="o">=</span><span class="m">2</span>
<span class="nv">IOSchedulingPriority</span><span class="o">=</span><span class="m">7</span>
    
<span class="nv">EnvironmentFile</span><span class="o">=</span>/home/x/pybs/systemd/pybs-monthly.env
    
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/bash -c <span class="s1">&#39;${BASE_DIR}/script/backup.sh&#39;</span></code></pre></div>
<p>Set <code>EnvironmentFile</code> variable to absolute path of env file which you have created. Leave all other things as it is.</p>

<p>We also need a systemd timer.</p>

<p><code>pybs/systemd/pybs-monthly.timer</code></p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">    
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Borg Monthly Backup Timer
    
<span class="o">[</span>Timer<span class="o">]</span>
<span class="nv">OnCalendar</span><span class="o">=</span>monthly
<span class="nv">AccuracySec</span><span class="o">=</span>1h
<span class="nv">Persistent</span><span class="o">=</span><span class="nb">true</span>
    
<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>timers.target</code></pre></div>
<p>The file should be named same as service file base name, but with .timer extension. The backup frequency is set with <code>OnCalendar</code> variable. Refer systemd documentation to know more about timers.</p>

<p>Finally, add backup entries for monthly backup. Label the backup sets with the label specified in env file.</p>

<p><code>pybs/backup.yml</code></p>
<div class="highlight"><pre class="chroma"><code class="language-YAML" data-lang="YAML"><span class="w">    
</span><span class="w"></span>backups<span class="p">:</span><span class="w">
</span><span class="w">    
</span><span class="w">  </span>music<span class="p">:</span><span class="w">
</span><span class="w">    </span>label<span class="p">:</span><span class="w"> </span>foo<span class="w">
</span><span class="w">    </span>dirs<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/home/x/Music<span class="w">
</span><span class="w">    </span>excludes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/home/x/Music/<span class="cp">*.wmv</span><span class="w">
</span><span class="w">    
</span><span class="w">  </span>picts<span class="p">:</span><span class="w">
</span><span class="w">    </span>label<span class="p">:</span><span class="w"> </span>weekly<span class="w">
</span><span class="w">    </span>dirs<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/home/x/Pictures<span class="w">
</span><span class="w">    </span></code></pre></div>
<p>The new backup service backups only the Music dir excluding all wmv files.</p>

<p>Thats all there is to configure. To run new backup service, copy and enable service and timer units as explained in <a href="#runpybs">Run Pybs</a></p>

      </main>
    </div>

    <aside id="sidebar-right" class="col-md-2">
    </aside>

  </div>
</div>

<footer class="container-fluid mt-5">

    <div class="row">
        <div class="col ml-auto">
            <div class="row mb-1 ml-2">
                <a class="text-muted" href="/privacy-policy">Privacy</a>
            </div>
            <div class="row text-muted mb-2 ml-2">
                <span>&copy; 2019 &middot;Powered by <a href="https://gohugo.io" target="_blank"
                        rel="noopener">Hugo</a></span>
            </div>
        </div>
        <div class="col mr-auto">
            <span class="float-right">
                <a href="#" id="back_to_top">
                    <i class="icon-up-open h1 text-secondary"></i>
                </a>
            </span>
        </div>
    </div>

</footer>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>








<script src="/js/vendor.min.8489448e4e75ceb388a38abde3871de9485502974c5feddcf04a3d413dc6e103.js"></script>
</body>

</html>